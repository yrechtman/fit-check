<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fit Check</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: #FAF8F5; color: #2D2A26; min-height: 100vh; }
    .font-display { font-family: 'Cormorant Garamond', serif; }
    .bg-cream { background: #FAF8F5; }
    .bg-warm { background: #F5F0E8; }
    .bg-sage { background: #E8EDE6; }
    .text-warm-gray { color: #6B6560; }
    .border-warm { border-color: #E5DFD6; }
    .btn-primary { background: #2D2A26; color: #FAF8F5; transition: all 0.2s ease; }
    .btn-primary:hover { background: #4A4640; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: transparent; border: 1px solid #2D2A26; color: #2D2A26; transition: all 0.2s ease; }
    .btn-secondary:hover { background: #2D2A26; color: #FAF8F5; }
    .card { background: white; border: 1px solid #E5DFD6; border-radius: 8px; }
    .input-field { background: white; border: 1px solid #E5DFD6; border-radius: 6px; padding: 10px 14px; width: 100%; transition: border-color 0.2s ease; }
    .input-field:focus { outline: none; border-color: #2D2A26; }
    .status-considering { background: #FEF3C7; color: #92400E; }
    .status-passed { background: #FEE2E2; color: #991B1B; }
    .status-purchased { background: #D1FAE5; color: #065F46; }
    textarea { resize: vertical; }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .tab-active { background: #2D2A26; color: white; }
    .tab-inactive { background: #F5F0E8; color: #6B6560; }
    .tab-inactive:hover { background: #E8EDE6; }
    .image-preview { width: 100%; height: 120px; object-fit: cover; border-radius: 6px; }
    .library-image { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; flex-shrink: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect } = React;
const SUPABASE_URL = 'https://poabdniawcezgvqszjfv.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvYWJkbmlhd2Nlemd2cXN6amZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2ODQ2MTIsImV4cCI6MjA4NDI2MDYxMn0.ilZ2G3DwL3aDkgTpVEoVFfGzeW1GlBMCQYn8ePSWcHY';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const storage = {
  get: (key, def) => { try { const i = localStorage.getItem(key); return i ? JSON.parse(i) : def; } catch { return def; } },
  set: (key, val) => localStorage.setItem(key, JSON.stringify(val))
};
const defaultBody = { height: '', weight: '', cupSize: '', bust: '', waist: '', hips: '', inseam: '', shoulderWidth: '', chest: '', neck: '', sleeve: '', suitSize: '', shoeSize: '', notes: '' };
const categories = ['Shirts & Tops', 'Sweaters & Knits', 'Dresses', 'Jackets & Coats', 'Pants & Jeans', 'Skirts', 'Suits & Blazers', 'Shoes', 'Other'];

function Auth({ onAuth }) {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const handleSubmit = async (e) => {
    e.preventDefault(); setLoading(true); setError(null);
    try {
      const { data, error } = isLogin 
        ? await supabase.auth.signInWithPassword({ email, password })
        : await supabase.auth.signUp({ email, password });
      if (error) throw error;
      if (data.user) onAuth(data.user);
    } catch (err) { setError(err.message); } finally { setLoading(false); }
  };
  return (
    <div className="min-h-screen bg-cream flex items-center justify-center p-6">
      <div className="card p-8 max-w-md w-full fade-in">
        <h1 className="font-display text-4xl font-medium text-center mb-2">Fit Check</h1>
        <p className="text-warm-gray text-center mb-8">Your personal vintage shopping assistant</p>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div><label className="block mb-2 text-sm font-medium">Email</label><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-field" required /></div>
          <div><label className="block mb-2 text-sm font-medium">Password</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="input-field" required minLength={6} /></div>
          {error && <div className="p-3 bg-red-50 text-red-700 rounded-lg text-sm">{error}</div>}
          <button type="submit" disabled={loading} className="btn-primary px-6 py-3 rounded-lg font-medium w-full">{loading ? 'Please wait...' : (isLogin ? 'Sign In' : 'Create Account')}</button>
        </form>
        <p className="text-center mt-6 text-sm text-warm-gray">{isLogin ? "Don't have an account? " : "Already have an account? "}<button onClick={() => setIsLogin(!isLogin)} className="underline">{isLogin ? 'Sign up' : 'Sign in'}</button></p>
      </div>
    </div>
  );
}

function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('check');
  const [profile, setProfile] = useState({ name: '', bodyMeasurements: defaultBody, preferences: '' });
  const [referenceItems, setReferenceItems] = useState([]);
  const [library, setLibrary] = useState([]);
  const [apiKey, setApiKey] = useState(() => storage.get('claudeApiKey', ''));
  const [showSettings, setShowSettings] = useState(false);

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => { setUser(session?.user ?? null); setLoading(false); });
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => { setUser(session?.user ?? null); });
    return () => subscription.unsubscribe();
  }, []);

  useEffect(() => { if (user) { loadProfile(); loadReferenceItems(); loadLibrary(); } }, [user]);
  useEffect(() => { storage.set('claudeApiKey', apiKey); }, [apiKey]);

  const loadProfile = async () => {
    const { data } = await supabase.from('profiles').select('*').eq('user_id', user.id).single();
    if (data) setProfile({ name: data.name || '', bodyMeasurements: data.body_measurements || defaultBody, preferences: data.preferences || '' });
  };
  const loadReferenceItems = async () => {
    const { data } = await supabase.from('reference_items').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
    if (data) setReferenceItems(data);
  };
  const loadLibrary = async () => {
    const { data } = await supabase.from('library_items').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
    if (data) setLibrary(data);
  };
  const saveProfile = async (updates) => {
    const newProfile = { ...profile, ...updates }; setProfile(newProfile);
    const { data: existing } = await supabase.from('profiles').select('id').eq('user_id', user.id).single();
    if (existing) await supabase.from('profiles').update({ name: newProfile.name, body_measurements: newProfile.bodyMeasurements, preferences: newProfile.preferences, updated_at: new Date().toISOString() }).eq('user_id', user.id);
    else await supabase.from('profiles').insert({ user_id: user.id, name: newProfile.name, body_measurements: newProfile.bodyMeasurements, preferences: newProfile.preferences });
  };
  const addReferenceItem = async (item) => {
    const { data } = await supabase.from('reference_items').insert({ ...item, user_id: user.id }).select().single();
    if (data) setReferenceItems(prev => [data, ...prev]);
  };
  const updateReferenceItem = async (id, updates) => {
    await supabase.from('reference_items').update(updates).eq('id', id);
    setReferenceItems(prev => prev.map(item => item.id === id ? { ...item, ...updates } : item));
  };
  const deleteReferenceItem = async (id) => {
    await supabase.from('reference_items').delete().eq('id', id);
    setReferenceItems(prev => prev.filter(item => item.id !== id));
  };
  const addToLibrary = async (item) => {
    const { data } = await supabase.from('library_items').insert({ ...item, user_id: user.id }).select().single();
    if (data) setLibrary(prev => [data, ...prev]);
  };
  const updateLibraryItem = async (id, updates) => {
    await supabase.from('library_items').update({ ...updates, updated_at: new Date().toISOString() }).eq('id', id);
    setLibrary(prev => prev.map(item => item.id === id ? { ...item, ...updates } : item));
  };
  const deleteLibraryItem = async (id) => {
    const item = library.find(i => i.id === id);
    if (item?.image_url) { const path = item.image_url.split('/listing-images/')[1]; if (path) await supabase.storage.from('listing-images').remove([path]); }
    await supabase.from('library_items').delete().eq('id', id);
    setLibrary(prev => prev.filter(item => item.id !== id));
  };
  const uploadImage = async (file) => {
    const fileExt = file.name.split('.').pop();
    const fileName = `${user.id}/${Date.now()}.${fileExt}`;
    const { error } = await supabase.storage.from('listing-images').upload(fileName, file);
    if (error) throw error;
    const { data } = supabase.storage.from('listing-images').getPublicUrl(fileName);
    return data.publicUrl;
  };
  const handleSignOut = async () => {
    await supabase.auth.signOut(); setUser(null);
    setProfile({ name: '', bodyMeasurements: defaultBody, preferences: '' }); setReferenceItems([]); setLibrary([]);
  };

  if (loading) return <div className="min-h-screen bg-cream flex items-center justify-center"><p className="text-warm-gray">Loading...</p></div>;
  if (!user) return <Auth onAuth={setUser} />;

  return (
    <div className="min-h-screen bg-cream">
      <header className="border-b border-warm bg-white sticky top-0 z-50">
        <div className="max-w-4xl mx-auto px-6 py-4 flex items-center justify-between">
          <h1 className="font-display text-3xl font-medium tracking-tight">Fit Check</h1>
          <div className="flex items-center gap-4">
            <span className="text-sm text-warm-gray hidden sm:block">{user.email}</span>
            <button onClick={() => setShowSettings(!showSettings)} className="text-warm-gray hover:text-2D2A26 transition-colors">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
          </div>
        </div>
      </header>
      {showSettings && (
        <div className="fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4" onClick={() => setShowSettings(false)}>
          <div className="card p-6 max-w-md w-full fade-in" onClick={e => e.stopPropagation()}>
            <h2 className="font-display text-2xl mb-4">Settings</h2>
            <label className="block mb-2 text-sm font-medium">Claude API Key</label>
            <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="sk-ant-..." className="input-field mb-2" />
            <p className="text-sm text-warm-gray mb-6">Get your API key from <a href="https://console.anthropic.com" target="_blank" className="underline">console.anthropic.com</a></p>
            <div className="flex gap-3">
              <button onClick={() => setShowSettings(false)} className="btn-primary px-4 py-2 rounded-lg flex-1">Done</button>
              <button onClick={handleSignOut} className="btn-secondary px-4 py-2 rounded-lg">Sign Out</button>
            </div>
          </div>
        </div>
      )}
      <nav className="border-b border-warm bg-white">
        <div className="max-w-4xl mx-auto px-6 flex gap-1">
          {[{ id: 'check', label: 'Check Listing' }, { id: 'library', label: 'Library' }, { id: 'profile', label: 'My Fit Profile' }].map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-4 py-3 text-sm font-medium transition-colors relative ${activeTab === tab.id ? 'text-2D2A26' : 'text-warm-gray hover:text-2D2A26'}`}>
              {tab.label}{activeTab === tab.id && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-2D2A26" />}
            </button>
          ))}
        </div>
      </nav>
      <main className="max-w-4xl mx-auto px-6 py-8">
        {activeTab === 'check' && <CheckListing profile={profile} referenceItems={referenceItems} apiKey={apiKey} onSave={addToLibrary} onNeedApiKey={() => setShowSettings(true)} uploadImage={uploadImage} />}
        {activeTab === 'library' && <Library items={library} onUpdate={updateLibraryItem} onDelete={deleteLibraryItem} />}
        {activeTab === 'profile' && <FitProfile profile={profile} referenceItems={referenceItems} onUpdateProfile={saveProfile} onAddItem={addReferenceItem} onUpdateItem={updateReferenceItem} onDeleteItem={deleteReferenceItem} apiKey={apiKey} onNeedApiKey={() => setShowSettings(true)} />}
      </main>
    </div>
  );
}

function CheckListing({ profile, referenceItems, apiKey, onSave, onNeedApiKey, uploadImage }) {
  const [listingText, setListingText] = useState('');
  const [listingUrl, setListingUrl] = useState('');
  const [listingPrice, setListingPrice] = useState('');
  const [imageFile, setImageFile] = useState(null);
  const [imagePreview, setImagePreview] = useState(null);
  const [loading, setLoading] = useState(false);
  const [fetching, setFetching] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState(null);
  const [needsMoreInfo, setNeedsMoreInfo] = useState(false);
  const hasProfile = profile.bodyMeasurements.height || referenceItems.length > 0;

  const handleImageChange = (e) => {
    const file = e.target.files[0];
    if (file) { setImageFile(file); const reader = new FileReader(); reader.onloadend = () => setImagePreview(reader.result); reader.readAsDataURL(file); }
  };
  const handlePaste = (e) => {
    const items = e.clipboardData?.items;
    if (!items) return;
    for (const item of items) {
      if (item.type.startsWith('image/')) {
        e.preventDefault();
        const file = item.getAsFile();
        if (file) {
          setImageFile(file);
          const reader = new FileReader();
          reader.onloadend = () => setImagePreview(reader.result);
          reader.readAsDataURL(file);
        }
        break;
      }
    }
  };
  useEffect(() => {
    document.addEventListener('paste', handlePaste);
    return () => document.removeEventListener('paste', handlePaste);
  }, []);
  const removeImage = () => { setImageFile(null); setImagePreview(null); };

  const fetchListing = async () => {
    if (!listingUrl.trim()) { setError('Please enter a URL'); return; }
    if (!listingUrl.includes('ebay.com') && !listingUrl.includes('ebay.co.uk')) { 
      setError('Only eBay URLs are supported. For other sites, paste the listing details manually.'); 
      return; 
    }
    setFetching(true); setError(null);
    try {
      const response = await fetch(`/api/fetch?url=${encodeURIComponent(listingUrl)}`);
      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'Failed to fetch listing');
      setListingText(data.summary);
      if (data.price && !listingPrice) setListingPrice(`$${data.price}`);
    } catch (err) { 
      setError(`Could not fetch listing: ${err.message}. Try pasting the listing details manually.`); 
    } finally { setFetching(false); }
  };

  const checkFit = async () => {
    if (!apiKey) { onNeedApiKey(); return; }
    if (!listingText.trim()) { setError('Please paste the listing details or fetch from URL'); return; }
    if (!hasProfile) { setError('Please add some measurements or reference items to your profile first'); return; }
    setLoading(true); setError(null); setResult(null); setNeedsMoreInfo(false);
    const profileSummary = buildProfileSummary(profile, referenceItems);
    const prompt = `You are a personal shopping assistant helping someone evaluate a vintage clothing item for fit, quality, and value.

Here is the shopper's fit profile:
${profileSummary}

Here is the listing they're considering:
${listingText}

${listingUrl ? `Listing URL: ${listingUrl}` : ''}
${listingPrice ? `Asking price: ${listingPrice}` : ''}

Please analyze this listing and provide:

1. **Fit Assessment**: Will this likely fit well? Compare against their reference items and body measurements. Be specific.

2. **Quality Assessment**: Based on the brand, materials, construction details, and condition described, assess the quality. Note any red flags or positive indicators.

3. **Value Assessment**: ${listingPrice ? `At ${listingPrice}, is this a good value?` : 'Without a price, comment on what would be a fair price range.'} Consider the brand, condition, and typical resale values for similar items.

4. **Confidence Level**: Rate your confidence (High/Medium/Low) for EACH of fit, quality, and value assessments.

5. **Recommendation**: Buy, Pass, or Need More Info?

6. **To Improve This Assessment** (IMPORTANT - always include this section):
   - If confidence is Medium or Low on fit: List what measurements to ask the seller for, AND/OR suggest what reference items the user should add to their profile (e.g., "Add a sport coat or blazer from your closet to improve jacket fit predictions")
   - If confidence is Medium or Low on quality: List what details to ask the seller about (materials, construction, flaws)
   - If confidence is Medium or Low on value: Note if price is missing or if you need comparable sales data
   - If confidence is High on everything: Just say "No additional information needed"

Be direct and practical. Reference their actual measurements and wardrobe when making comparisons.`;
    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
        body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1500, messages: [{ role: 'user', content: prompt }] })
      });
      if (!response.ok) { const errorData = await response.json().catch(() => ({})); throw new Error(errorData.error?.message || `API error: ${response.status}`); }
      const data = await response.json();
      const analysis = data.content[0].text;
      const needsInfo = analysis.toLowerCase().includes('need more info') || analysis.toLowerCase().includes('medium') || analysis.toLowerCase().includes('low');
      setNeedsMoreInfo(needsInfo);
      setResult({ analysis, listingText, listingUrl, listingPrice, timestamp: new Date().toISOString() });
    } catch (err) { setError(err.message || 'Failed to analyze listing'); } finally { setLoading(false); }
  };

  const saveToLibrary = async (status) => {
    let imageUrl = '';
    if (imageFile) { try { imageUrl = await uploadImage(imageFile); } catch (err) { console.error('Failed to upload image:', err); } }
    await onSave({ listing_text: result.listingText, listing_url: result.listingUrl, analysis: result.analysis, status, image_url: imageUrl, notes: result.listingPrice ? `Price: ${result.listingPrice}` : '' });
    setResult(null); setListingText(''); setListingUrl(''); setListingPrice(''); setImageFile(null); setImagePreview(null); setNeedsMoreInfo(false);
  };

  return (
    <div className="space-y-6 fade-in">
      <div><h2 className="font-display text-2xl mb-2">Check a Listing</h2><p className="text-warm-gray">Paste listing details to evaluate fit, quality, and value.</p></div>
      {!hasProfile && <div className="card p-4 bg-warm border-none"><p className="text-sm"><strong>Tip:</strong> Add your measurements and some reference items to your profile first for better fit analysis.</p></div>}
      <div className="card p-6 space-y-4">
        <div>
          <label className="block mb-2 text-sm font-medium">Listing Image (optional)</label>
          {imagePreview ? (
            <div className="relative">
              <img src={imagePreview} alt="Preview" className="image-preview" />
              <button onClick={removeImage} className="absolute top-2 right-2 bg-white rounded-full p-1 shadow hover:bg-gray-100"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
          ) : (
            <div className="border-2 border-dashed border-warm rounded-lg p-6 text-center">
              <svg className="w-8 h-8 mx-auto text-warm-gray mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
              <p className="text-sm text-warm-gray mb-1">Paste an image</p>
              <p className="text-xs text-warm-gray mb-3">Press {navigator.platform?.includes('Mac') ? '⌘' : 'Ctrl'}+V anywhere on this page</p>
              <label className="inline-flex items-center gap-1.5 text-xs text-warm-gray hover:text-gray-600 cursor-pointer transition-colors">
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                <span>or upload a file</span>
                <input type="file" accept="image/*" onChange={handleImageChange} className="hidden" />
              </label>
            </div>
          )}
        </div>
        <div>
          <label className="block mb-2 text-sm font-medium">eBay URL</label>
          <div className="flex gap-2">
            <input type="url" value={listingUrl} onChange={(e) => setListingUrl(e.target.value)} placeholder="https://www.ebay.com/itm/..." className="input-field flex-1" />
            <button onClick={fetchListing} disabled={fetching || !listingUrl.trim()} className="btn-secondary px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap">{fetching ? 'Fetching...' : 'Fetch Listing'}</button>
          </div>
          <p className="text-xs text-warm-gray mt-1">Paste an eBay link and click Fetch, or manually paste listing details below</p>
        </div>
        <div>
          <label className="block mb-2 text-sm font-medium">Price (optional)</label>
          <input type="text" value={listingPrice} onChange={(e) => setListingPrice(e.target.value)} placeholder="$150" className="input-field" />
        </div>
        <div><label className="block mb-2 text-sm font-medium">Listing Details *</label><textarea value={listingText} onChange={(e) => setListingText(e.target.value)} placeholder="Paste the listing title, description, measurements, size, condition, etc. â€” or use Fetch Listing above" rows={8} className="input-field" /></div>
        {error && <div className="p-3 bg-red-50 text-red-700 rounded-lg text-sm">{error}</div>}
        <button onClick={checkFit} disabled={loading} className="btn-primary px-6 py-3 rounded-lg font-medium w-full">{loading ? 'Analyzing...' : 'Check Listing'}</button>
      </div>
      {result && (
        <div className="card p-6 space-y-4 fade-in">
          <h3 className="font-display text-xl">Analysis</h3>
          <div className="prose prose-sm max-w-none text-warm-gray whitespace-pre-wrap">{result.analysis}</div>
          {needsMoreInfo && (
            <div className="pt-4 border-t border-warm">
              <p className="text-sm text-warm-gray mb-3">Update the listing details above or add items to your profile, then:</p>
              <button onClick={checkFit} disabled={loading} className="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">{loading ? 'Re-checking...' : 'Re-check Listing'}</button>
            </div>
          )}
          <div className="pt-4 border-t border-warm">
            <p className="text-sm font-medium mb-3">Save to library as:</p>
            <div className="flex gap-2 flex-wrap">
              <button onClick={() => saveToLibrary('considering')} className="px-4 py-2 rounded-lg text-sm font-medium status-considering">Considering</button>
              <button onClick={() => saveToLibrary('passed')} className="px-4 py-2 rounded-lg text-sm font-medium status-passed">Pass</button>
              <button onClick={() => saveToLibrary('purchased')} className="px-4 py-2 rounded-lg text-sm font-medium status-purchased">Purchased</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function Library({ items, onUpdate, onDelete }) {
  const [filter, setFilter] = useState('all');
  const [expandedId, setExpandedId] = useState(null);
  const filteredItems = filter === 'all' ? items : items.filter(item => item.status === filter);
  const statusCounts = { all: items.length, considering: items.filter(i => i.status === 'considering').length, passed: items.filter(i => i.status === 'passed').length, purchased: items.filter(i => i.status === 'purchased').length };
  return (
    <div className="space-y-6 fade-in">
      <div><h2 className="font-display text-2xl mb-2">Your Library</h2><p className="text-warm-gray">Track listings you've checked.</p></div>
      <div className="flex gap-2 flex-wrap">
        {['all', 'considering', 'passed', 'purchased'].map(f => (
          <button key={f} onClick={() => setFilter(f)} className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${filter === f ? 'tab-active' : 'tab-inactive'}`}>{f.charAt(0).toUpperCase() + f.slice(1)} ({statusCounts[f]})</button>
        ))}
      </div>
      {filteredItems.length === 0 ? (
        <div className="card p-8 text-center text-warm-gray">{items.length === 0 ? "No listings yet. Check a listing to add it to your library." : "No listings match this filter."}</div>
      ) : (
        <div className="space-y-3">{filteredItems.map(item => <LibraryItem key={item.id} item={item} expanded={expandedId === item.id} onToggle={() => setExpandedId(expandedId === item.id ? null : item.id)} onUpdate={(updates) => onUpdate(item.id, updates)} onDelete={() => onDelete(item.id)} />)}</div>
      )}
    </div>
  );
}

function LibraryItem({ item, expanded, onToggle, onUpdate, onDelete }) {
  const [notes, setNotes] = useState(item.notes || '');
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const statusStyles = { considering: 'status-considering', passed: 'status-passed', purchased: 'status-purchased' };
  const getListingPreview = () => { const firstLine = (item.listing_text || '').split('\n')[0]; return firstLine.length > 60 ? firstLine.slice(0, 60) + '...' : firstLine; };
  return (
    <div className="card overflow-hidden">
      <div className="p-4 cursor-pointer hover:bg-warm/50 transition-colors" onClick={onToggle}>
        <div className="flex items-start gap-4">
          {item.image_url && <img src={item.image_url} alt="" className="library-image" />}
          <div className="flex-1 min-w-0">
            <div className="flex items-start justify-between gap-2">
              <p className="font-medium truncate">{getListingPreview()}</p>
              <span className={`px-2 py-1 rounded text-xs font-medium whitespace-nowrap ${statusStyles[item.status]}`}>{item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span>
            </div>
            <p className="text-sm text-warm-gray mt-1">{new Date(item.created_at).toLocaleDateString()}</p>
          </div>
        </div>
      </div>
      {expanded && (
        <div className="border-t border-warm p-4 space-y-4 fade-in">
          {item.listing_url && <a href={item.listing_url} target="_blank" rel="noopener noreferrer" className="text-sm text-blue-600 hover:underline block">View Original Listing â†’</a>}
          <div><h4 className="text-sm font-medium mb-2">Listing Details</h4><p className="text-sm text-warm-gray whitespace-pre-wrap bg-warm p-3 rounded-lg max-h-40 overflow-y-auto">{item.listing_text}</p></div>
          <div><h4 className="text-sm font-medium mb-2">Fit Analysis</h4><p className="text-sm text-warm-gray whitespace-pre-wrap">{item.analysis}</p></div>
          <div><h4 className="text-sm font-medium mb-2">Your Notes</h4><textarea value={notes} onChange={(e) => setNotes(e.target.value)} onBlur={() => notes !== item.notes && onUpdate({ notes })} placeholder="Add personal notes..." rows={2} className="input-field text-sm" /></div>
          <div className="flex items-center justify-between pt-2">
            <div className="flex gap-2"><label className="text-sm text-warm-gray">Status:</label><select value={item.status} onChange={(e) => onUpdate({ status: e.target.value })} className="text-sm bg-transparent border-none focus:ring-0 cursor-pointer"><option value="considering">Considering</option><option value="passed">Passed</option><option value="purchased">Purchased</option></select></div>
            {showDeleteConfirm ? (<div className="flex gap-2 items-center"><span className="text-sm text-warm-gray">Delete?</span><button onClick={onDelete} className="text-sm text-red-600 font-medium">Yes</button><button onClick={() => setShowDeleteConfirm(false)} className="text-sm text-warm-gray">No</button></div>) : (<button onClick={() => setShowDeleteConfirm(true)} className="text-sm text-warm-gray hover:text-red-600 transition-colors">Delete</button>)}
          </div>
        </div>
      )}
    </div>
  );
}

function FitProfile({ profile, referenceItems, onUpdateProfile, onAddItem, onUpdateItem, onDeleteItem, apiKey, onNeedApiKey }) {
  const [activeSection, setActiveSection] = useState('body');
  const [editingItem, setEditingItem] = useState(null);
  const updateBodyMeasurement = (field, value) => onUpdateProfile({ bodyMeasurements: { ...profile.bodyMeasurements, [field]: value } });
  const updatePreferences = (value) => onUpdateProfile({ preferences: value });
  return (
    <div className="space-y-6 fade-in">
      <div><h2 className="font-display text-2xl mb-2">My Fit Profile</h2><p className="text-warm-gray">Your measurements, preferences, and reference items help us analyze fit.</p></div>
      <div className="flex gap-2 flex-wrap">
        <button onClick={() => setActiveSection('body')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${activeSection === 'body' ? 'tab-active' : 'tab-inactive'}`}>Body Measurements</button>
        <button onClick={() => setActiveSection('preferences')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${activeSection === 'preferences' ? 'tab-active' : 'tab-inactive'}`}>Preferences</button>
        <button onClick={() => setActiveSection('items')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${activeSection === 'items' ? 'tab-active' : 'tab-inactive'}`}>{profile.name ? `${profile.name}'s Wardrobe` : 'Reference Items'} ({referenceItems.length})</button>
      </div>
      {activeSection === 'body' && (
        <div className="card p-6 space-y-6">
          <div>
            <label className="block mb-2 text-sm font-medium">Your Name</label>
            <input type="text" value={profile.name || ''} onChange={(e) => onUpdateProfile({ name: e.target.value })} placeholder="e.g., ZoÃ«" className="input-field" />
          </div>
          <div className="border-t border-warm pt-6">
            <h4 className="text-sm font-medium mb-4 text-warm-gray">General Measurements</h4>
            <div className="grid grid-cols-2 gap-4">
              {[{ key: 'height', label: 'Height', placeholder: '5\'6"' }, { key: 'weight', label: 'Weight', placeholder: '130 lbs' }, { key: 'waist', label: 'Waist', placeholder: '28"' }, { key: 'hips', label: 'Hips', placeholder: '38"' }, { key: 'inseam', label: 'Inseam', placeholder: '30"' }, { key: 'shoulderWidth', label: 'Shoulder Width', placeholder: '15"' }, { key: 'shoeSize', label: 'Shoe Size', placeholder: '8' }].map(field => (
                <div key={field.key}><label className="block mb-2 text-sm font-medium">{field.label}</label><input type="text" value={profile.bodyMeasurements[field.key] || ''} onChange={(e) => updateBodyMeasurement(field.key, e.target.value)} placeholder={field.placeholder} className="input-field" /></div>
              ))}
            </div>
          </div>
          <div className="border-t border-warm pt-6">
            <h4 className="text-sm font-medium mb-4 text-warm-gray">Women's Measurements</h4>
            <div className="grid grid-cols-2 gap-4">
              {[{ key: 'cupSize', label: 'Bra Size', placeholder: '34C' }, { key: 'bust', label: 'Bust', placeholder: '36"' }].map(field => (
                <div key={field.key}><label className="block mb-2 text-sm font-medium">{field.label}</label><input type="text" value={profile.bodyMeasurements[field.key] || ''} onChange={(e) => updateBodyMeasurement(field.key, e.target.value)} placeholder={field.placeholder} className="input-field" /></div>
              ))}
            </div>
          </div>
          <div className="border-t border-warm pt-6">
            <h4 className="text-sm font-medium mb-4 text-warm-gray">Men's Measurements</h4>
            <div className="grid grid-cols-2 gap-4">
              {[{ key: 'chest', label: 'Chest', placeholder: '40"' }, { key: 'neck', label: 'Neck', placeholder: '15.5"' }, { key: 'sleeve', label: 'Sleeve', placeholder: '34"' }, { key: 'suitSize', label: 'Suit/Jacket Size', placeholder: '40R' }].map(field => (
                <div key={field.key}><label className="block mb-2 text-sm font-medium">{field.label}</label><input type="text" value={profile.bodyMeasurements[field.key] || ''} onChange={(e) => updateBodyMeasurement(field.key, e.target.value)} placeholder={field.placeholder} className="input-field" /></div>
              ))}
            </div>
          </div>
          <div><label className="block mb-2 text-sm font-medium">General Fit Notes</label><textarea value={profile.bodyMeasurements.notes || ''} onChange={(e) => updateBodyMeasurement('notes', e.target.value)} placeholder="E.g., Long torso, short arms, prefer looser fits..." rows={3} className="input-field" /></div>
        </div>
      )}
      {activeSection === 'preferences' && (
        <div className="card p-6">
          <label className="block mb-2 text-sm font-medium">Style & Material Preferences</label>
          <textarea value={profile.preferences || ''} onChange={(e) => updatePreferences(e.target.value)} placeholder="E.g., Prefer natural fibers like cotton, linen, wool. Avoid polyester. Like earth tones and neutrals. Prefer relaxed fits over tight. Love vintage 70s and 80s styles..." rows={6} className="input-field" />
          <p className="text-sm text-warm-gray mt-2">These preferences will be considered when analyzing listings.</p>
        </div>
      )}
      {activeSection === 'items' && (
        <div className="space-y-4">
          {editingItem ? (
            editingItem.isNew ? (
              <AddItemNaturalLanguage apiKey={apiKey} onSave={onAddItem} onCancel={() => setEditingItem(null)} onNeedApiKey={onNeedApiKey} />
            ) : (
              <ReferenceItemForm item={editingItem} onSave={(data) => { onUpdateItem(editingItem.id, data); setEditingItem(null); }} onCancel={() => setEditingItem(null)} />
            )
          ) : (
            <button onClick={() => setEditingItem({ isNew: true })} className="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">+ Add Reference Item</button>
          )}
          {referenceItems.length === 0 && !editingItem ? (<div className="card p-8 text-center text-warm-gray">Add items from your closet that fit well to build your fit profile.</div>) : (<div className="space-y-3">{referenceItems.map(item => <ReferenceItemCard key={item.id} item={item} onEdit={() => setEditingItem(item)} onDelete={() => onDeleteItem(item.id)} />)}</div>)}
        </div>
      )}
    </div>
  );
}

function AddItemNaturalLanguage({ apiKey, onSave, onCancel, onNeedApiKey }) {
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [parsedData, setParsedData] = useState(null);

  const parseItem = async () => {
    if (!apiKey) { onNeedApiKey(); return; }
    if (!input.trim()) { setError('Please describe the item'); return; }
    setLoading(true); setError(null);

    const prompt = `Parse this clothing item description into structured data. Extract what you can, leave fields empty if not mentioned.

Description: "${input}"

Valid categories: Shirts & Tops, Sweaters & Knits, Dresses, Jackets & Coats, Pants & Jeans, Skirts, Suits & Blazers, Shoes, Other

Respond ONLY with valid JSON in this exact format, no other text:
{"category": "", "brand": "", "size": "", "fit_notes": "", "measurements": ""}

Examples:
- "Drake's dress shirt 17.5-44 slim fit" â†’ {"category": "Shirts & Tops", "brand": "Drake's", "size": "17.5-44", "fit_notes": "slim fit", "measurements": ""}
- "Levi's 501 jeans 32x30, a bit tight in the thighs" â†’ {"category": "Pants & Jeans", "brand": "Levi's 501", "size": "32x30", "fit_notes": "a bit tight in the thighs", "measurements": ""}
- "vintage Brooks Brothers navy blazer 42R, shoulders 18 inches" â†’ {"category": "Suits & Blazers", "brand": "Brooks Brothers", "size": "42R", "fit_notes": "vintage, navy", "measurements": "shoulders 18 inches"}`;

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
        body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 256, messages: [{ role: 'user', content: prompt }] })
      });
      if (!response.ok) { const errorData = await response.json().catch(() => ({})); throw new Error(errorData.error?.message || `API error: ${response.status}`); }
      const data = await response.json();
      const text = data.content[0].text.trim();
      const parsed = JSON.parse(text);
      setParsedData(parsed);
    } catch (err) { setError(err.message || 'Failed to parse item'); } finally { setLoading(false); }
  };

  const handleSave = () => {
    if (!parsedData.category || !parsedData.brand || !parsedData.size) { setError('Category, brand, and size are required'); return; }
    onSave(parsedData);
  };

  if (parsedData) {
    return (
      <div className="card p-6 space-y-4 fade-in">
        <h3 className="font-display text-lg">Review & Save</h3>
        <p className="text-sm text-warm-gray">Check that this looks right, then save or edit.</p>
        <div className="grid grid-cols-2 gap-4">
          <div><label className="block mb-2 text-sm font-medium">Category *</label><select value={parsedData.category} onChange={(e) => setParsedData({ ...parsedData, category: e.target.value })} className="input-field"><option value="">Select...</option>{categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select></div>
          <div><label className="block mb-2 text-sm font-medium">Brand *</label><input type="text" value={parsedData.brand} onChange={(e) => setParsedData({ ...parsedData, brand: e.target.value })} className="input-field" /></div>
        </div>
        <div><label className="block mb-2 text-sm font-medium">Size *</label><input type="text" value={parsedData.size} onChange={(e) => setParsedData({ ...parsedData, size: e.target.value })} className="input-field" /></div>
        <div><label className="block mb-2 text-sm font-medium">Fit Notes</label><textarea value={parsedData.fit_notes} onChange={(e) => setParsedData({ ...parsedData, fit_notes: e.target.value })} rows={2} className="input-field" /></div>
        <div><label className="block mb-2 text-sm font-medium">Measurements</label><textarea value={parsedData.measurements} onChange={(e) => setParsedData({ ...parsedData, measurements: e.target.value })} rows={2} className="input-field" /></div>
        {error && <div className="p-3 bg-red-50 text-red-700 rounded-lg text-sm">{error}</div>}
        <div className="flex gap-3 pt-2">
          <button onClick={handleSave} className="btn-primary px-4 py-2 rounded-lg text-sm font-medium">Save Item</button>
          <button onClick={() => setParsedData(null)} className="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">Back</button>
          <button onClick={onCancel} className="text-sm text-warm-gray hover:text-red-600 ml-auto">Cancel</button>
        </div>
      </div>
    );
  }

  return (
    <div className="card p-6 space-y-4 fade-in">
      <h3 className="font-display text-lg">Add Reference Item</h3>
      <div>
        <label className="block mb-2 text-sm font-medium">Describe an item from your closet</label>
        <textarea value={input} onChange={(e) => setInput(e.target.value)} placeholder="e.g., Drakes dress shirt 17.5-44, slim fit, slightly long in the sleeves" rows={3} className="input-field" />
      </div>
      {error && <div className="p-3 bg-red-50 text-red-700 rounded-lg text-sm">{error}</div>}
      <div className="flex gap-3">
        <button onClick={parseItem} disabled={loading} className="btn-primary px-4 py-2 rounded-lg text-sm font-medium">{loading ? 'Parsing...' : 'Add Item'}</button>
        <button onClick={onCancel} className="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">Cancel</button>
      </div>
    </div>
  );
}

function ReferenceItemForm({ item, onSave, onCancel }) {
  const [formData, setFormData] = useState({ category: item?.category || '', brand: item?.brand || '', size: item?.size || '', fit_notes: item?.fit_notes || '', measurements: item?.measurements || '' });
  const handleSubmit = (e) => { e.preventDefault(); if (!formData.category || !formData.brand || !formData.size) return; onSave(formData); };
  return (
    <form onSubmit={handleSubmit} className="card p-6 space-y-4 fade-in">
      <h3 className="font-display text-lg">{item ? 'Edit Item' : 'Add Reference Item'}</h3>
      <div className="grid grid-cols-2 gap-4">
        <div><label className="block mb-2 text-sm font-medium">Category *</label><select value={formData.category} onChange={(e) => setFormData({ ...formData, category: e.target.value })} className="input-field" required><option value="">Select...</option>{categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}</select></div>
        <div><label className="block mb-2 text-sm font-medium">Brand *</label><input type="text" value={formData.brand} onChange={(e) => setFormData({ ...formData, brand: e.target.value })} placeholder="e.g., Everlane" className="input-field" required /></div>
      </div>
      <div><label className="block mb-2 text-sm font-medium">Size *</label><input type="text" value={formData.size} onChange={(e) => setFormData({ ...formData, size: e.target.value })} placeholder="e.g., Small, 4, 27" className="input-field" required /></div>
      <div><label className="block mb-2 text-sm font-medium">Fit Notes</label><textarea value={formData.fit_notes} onChange={(e) => setFormData({ ...formData, fit_notes: e.target.value })} placeholder="e.g., Fits perfectly, slightly loose in shoulders, runs small..." rows={2} className="input-field" /></div>
      <div><label className="block mb-2 text-sm font-medium">Measurements (optional)</label><textarea value={formData.measurements} onChange={(e) => setFormData({ ...formData, measurements: e.target.value })} placeholder='e.g., Pit to pit: 19", Length: 26", Sleeve: 24"' rows={2} className="input-field" /></div>
      <div className="flex gap-3 pt-2"><button type="submit" className="btn-primary px-4 py-2 rounded-lg text-sm font-medium">{item ? 'Save Changes' : 'Add Item'}</button><button type="button" onClick={onCancel} className="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">Cancel</button></div>
    </form>
  );
}

function ReferenceItemCard({ item, onEdit, onDelete }) {
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  return (
    <div className="card p-4">
      <div className="flex items-start justify-between">
        <div>
          <div className="flex items-center gap-2 mb-1"><span className="text-xs px-2 py-0.5 bg-sage rounded">{item.category}</span></div>
          <p className="font-medium">{item.brand} - {item.size}</p>
          {item.fit_notes && <p className="text-sm text-warm-gray mt-1">{item.fit_notes}</p>}
          {item.measurements && <p className="text-sm text-warm-gray mt-1 font-mono">{item.measurements}</p>}
        </div>
        <div className="flex gap-2">
          <button onClick={onEdit} className="text-sm text-warm-gray hover:text-2D2A26">Edit</button>
          {showDeleteConfirm ? (<div className="flex gap-1"><button onClick={onDelete} className="text-sm text-red-600">Yes</button><button onClick={() => setShowDeleteConfirm(false)} className="text-sm text-warm-gray">No</button></div>) : (<button onClick={() => setShowDeleteConfirm(true)} className="text-sm text-warm-gray hover:text-red-600">Delete</button>)}
        </div>
      </div>
    </div>
  );
}

function buildProfileSummary(profile, referenceItems) {
  let summary = '';
  if (profile.name) summary += `Shopper: ${profile.name}\n\n`;
  const body = profile.bodyMeasurements;
  const bodyParts = [];
  if (body.height) bodyParts.push(`Height: ${body.height}`);
  if (body.weight) bodyParts.push(`Weight: ${body.weight}`);
  if (body.chest) bodyParts.push(`Chest: ${body.chest}`);
  if (body.cupSize) bodyParts.push(`Bra size: ${body.cupSize}`);
  if (body.bust) bodyParts.push(`Bust: ${body.bust}`);
  if (body.waist) bodyParts.push(`Waist: ${body.waist}`);
  if (body.hips) bodyParts.push(`Hips: ${body.hips}`);
  if (body.inseam) bodyParts.push(`Inseam: ${body.inseam}`);
  if (body.shoulderWidth) bodyParts.push(`Shoulder width: ${body.shoulderWidth}`);
  if (body.neck) bodyParts.push(`Neck: ${body.neck}`);
  if (body.sleeve) bodyParts.push(`Sleeve: ${body.sleeve}`);
  if (body.suitSize) bodyParts.push(`Suit/Jacket size: ${body.suitSize}`);
  if (body.shoeSize) bodyParts.push(`Shoe size: ${body.shoeSize}`);
  if (bodyParts.length > 0) { summary += `BODY MEASUREMENTS:\n${bodyParts.join('\n')}`; if (body.notes) summary += `\nGeneral fit notes: ${body.notes}`; summary += '\n\n'; }
  if (profile.preferences) { summary += `STYLE & MATERIAL PREFERENCES:\n${profile.preferences}\n\n`; }
  if (referenceItems.length > 0) {
    summary += 'REFERENCE ITEMS (clothes that fit well):\n';
    referenceItems.forEach((item, i) => { summary += `\n${i + 1}. ${item.category}: ${item.brand} - Size ${item.size}`; if (item.fit_notes) summary += `\n   Fit notes: ${item.fit_notes}`; if (item.measurements) summary += `\n   Measurements: ${item.measurements}`; });
  }
  return summary || 'No profile information provided yet.';
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
